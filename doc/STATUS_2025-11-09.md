# 项目状态快照 - 2025-11-09

## 时间与背景
- 日期：2025-11-09
- 目标：在独立项目中对医学影像分割数据集（当前示例 ORD5K）进行 UNet K 折训练，挖掘“困难样本”（预测指标差或不确定度高）以反馈到标注系统。

## 当前构建
- 目录结构：
  - rawig/ORD5K/ (原始数据集文件夹，已存在但尚未生成 manifest)
  - manifests/ (放各数据集清单)
  - src/ (models, data, utils, train, scripts)
  - outputs/ (训练与筛选结果，运行后生成)
  - configs/ord5k.yaml (参数样例)
  - doc/ (文档记录)
- 依赖：`torch`, `torchvision`, `numpy`, `pandas`, `scikit-learn`, `Pillow`, `tqdm`, `PyYAML`。
- 模型：简化 UNet，支持 n_classes，使用 Dropout 以便 MC Dropout 获取不确定度。

## 核心思路
1. 数据集统一入口是 manifest：避免耦合原始目录结构，利于多数据集适配。
2. 训练采用 KFold：对样本级指标更公平，防止单一划分偏差。
3. 困难样本定义（初版）：
   - 指标（IoU 或 mIoU / Dice 或 mDice）低于阈值 `iou_th`。
   - 排名位于最差百分位 `hard_percent`。
   - 两者并集 + 附加不确定度值（MC Dropout 熵均值）供二次筛选。
4. 不确定度：通过多次前向采样的像素概率熵平均衡量模型置信度。
5. 输出：hard_sample_ids.txt + metrics_fold_*.csv + hard_samples.csv。

## ORD5K 数据集初步规划 (更新：确认无分割掩膜，转分类)
已验证 `rawig/ORD5K/` 中仅有 `preprocessed_images/` 与 `full_df.csv`，无任何 mask 文件夹，因此当前无法进行像素级分割训练。本数据集原始任务为眼底多标签疾病识别（8 个类别：N,D,G,C,A,H,M,O）。

分类策略采纳：以“右眼图像”为单样本（第一阶段简化），使用 `target` 8 维多标签向量。

后续可扩展：
1. 左右眼各自样本（加倍数据量与视角）。
2. 左右双眼特征融合（拼接 embedding）。
3. 若后续获取病灶分割标注，再并行启用原 UNet 分割管线。

即将执行：
1. 构造分类 manifest：`manifests/ord5k_cls.csv`。
2. 新增分类模型与 K 折脚本：`src/models/classifier.py`, `src/train/kfold_classifier.py`。
3. 小规模试训（2 epoch）输出困难样本文件。

## 已完成
- 项目初始化与核心脚本开发。
- 支持二/多分类通用训练与难例筛选逻辑。
- 文档基础骨架与变更记录。

## 待办与改进方向
1. [ ] 无掩膜不确定度模式（仅推断，不训练）：通过已有权重评估熵筛样本。
2. [ ] 颜色标注掩膜自动转换（解析 RGB/调色板 -> 类别索引）。
3. [ ] 配置加载器：允许 `--config configs/xxx.yaml` 一键覆盖命令行参数。
4. [ ] 数据增强：随机翻转、缩放、颜色扰动，提升泛化（需要引入 albumentations 或自定义）。
5. [ ] 指标统计扩展：添加每类 IoU、频次分布，支持长尾分析。
6. [ ] 失败样本自动可视化（叠加预测 vs GT 热力图）。
7. [ ] DICOM/NIfTI 读取支持（医学格式通用化）。
8. [ ] 与标注系统的轻量集成脚本：将困难样本 id 推送到指定后端目录或 API。

## 风险与注意事项
- 若 ORD5K 缺少掩膜，目前训练脚本会直接报错（需要无监督模式）；
- 多分类掩膜若使用彩色编码，当前版本将视为灰度，可能导致类别混淆；需补颜色映射。
- 不确定度依赖 Dropout 分布性，过低的 dropout_p 可能导致熵值区分度不明显。

## 后续下一步建议
1. 确认并生成 ORD5K manifest。
2. 跑一轮小 epoch（如 2-3）验证输出格式。
3. 增加 `--config` 参数支持 YAML 加载。

---
本文档为一次性快照；后续更新请新增新的 STATUS 文件或在 CHANGELOG 增量记录。
